<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Play Nine Scorecard</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="theme-color" content="#0f5a43">

  <style>
    :root{
      --green-900:#0b3d2e;
      --green-700:#0f5a43;
      --green-600:#146b4f;
      --green-100:#e7f5ee;

      --yellow-500:#f6c343;
      --yellow-200:#ffe8a3;

      --paper:#f7fbf8;
      --card:#ffffff;

      --border:#d7e6dd;
      --muted:#4f6b5d;
      --danger:#b42318;
    }

    body { font-family: Arial, sans-serif; background: var(--paper); padding: 10px; color: var(--green-900); }
    h1, h2 { text-align: center; margin: 10px 0; }

    #tabs { display:flex; justify-content:center; gap:8px; margin: 10px 0 12px; }
    #tabs button{
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--green-900);
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 999px;
      cursor: pointer;
    }
    #tabs button:hover{ border-color: var(--green-600); }

    .active-tab{
      background: var(--green-700) !important;
      color: white !important;
      border-color: var(--green-700) !important;
      font-weight: bold;
    }

    #controls{ text-align:center; margin-bottom: 10px; }

    input, button{
      font-size: 14px;
      padding: 7px 10px;
      margin: 2px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    input{ background: var(--card); min-width: 170px; }

    button{
      cursor:pointer;
      background: var(--green-700);
      color: white;
      border-color: var(--green-700);
    }
    button:hover{ background: var(--green-600); border-color: var(--green-600); }

    button.secondary{
      background: var(--yellow-500);
      color: var(--green-900);
      border-color: var(--yellow-500);
      font-weight: bold;
    }
    button.secondary:hover{
      background: var(--yellow-200);
      border-color: var(--yellow-200);
    }

    button.light{
      background: var(--card);
      color: var(--green-900);
      border-color: var(--border);
      font-weight: bold;
    }
    button.light:hover{
      border-color: var(--yellow-500);
      background: var(--yellow-200);
    }

    .table-wrapper { overflow-x:auto; }

    table{
      width:auto;
      border-collapse:collapse;
      background: var(--card);
      margin: 12px auto 15px;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    th, td{ border: 1px solid var(--border); padding: 7px 10px; text-align:center; white-space:nowrap; }
    th{ background: var(--green-100); color: var(--green-900); font-weight: bold; }

    td input{
      width: 58px;
      text-align:center;
      padding: 6px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--green-900);
    }
    td input:focus{ outline: 2px solid var(--yellow-500); border-color: var(--yellow-500); }

    .total-row{ font-weight:bold; background: #fbfdfc; }
    .leader{ background: #fff7db; } /* lowest leader highlight */

    .player-header{ display:inline-flex; align-items:center; gap:6px; }
    .player-header button{
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--green-900);
    }
    .player-header button:hover{ border-color: var(--yellow-500); background: var(--yellow-200); }

    .danger{
      color: var(--danger);
      background: #fff;
      border-color: #f2c7c4;
      font-weight: bold;
    }
    .danger:hover{ background:#fde8e7; border-color:#f2c7c4; }

    .muted{ color: var(--muted); text-align:center; margin: 10px 0; }

    .summary-cards{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 8px 0 12px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      min-width: 260px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }

    .card .label{ color: var(--muted); font-size: 12px; margin-bottom: 4px; }
    .card .value{
      font-size: 18px;
      font-weight: bold;
      color: var(--green-900);
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      text-align: center;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--green-100);
      font-size: 18px;
      line-height: 1;
      flex: 0 0 auto;
    }
    .badge.trophy{ background: #fff2c9; border-color: #f1d37b; }
    .badge.oops{ background: #ffe7e5; border-color: #f2c7c4; }

    .history-actions{
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap: wrap;
      margin: 6px 0 12px;
    }
  </style>
</head>
<body>

<h1>Play Nine Scorecard</h1>

<div id="tabs">
  <button id="scoreTab" class="active-tab">Scorecard</button>
  <button id="historyTab">History</button>
</div>

<div id="scorecardView">
  <div id="controls">
    <input id="playerName" placeholder="Player name" />
    <button id="addPlayerBtn">Add Player</button>
    <button id="endGameBtn" class="secondary">End Game</button>
    <button id="resetScoresBtn">Reset Scores</button>
  </div>

  <div class="table-wrapper" id="tableContainer"></div>
  <div id="ranking"></div>
</div>

<div id="historyView" style="display:none"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, updateDoc, doc,
    query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyANco7Z5TrnOEeXrReubwTxFlIsw1Sr0Ck",
    authDomain: "play-nine-scorecard-f56ad.firebaseapp.com",
    projectId: "play-nine-scorecard-f56ad",
    storageBucket: "play-nine-scorecard-f56ad.firebasestorage.app",
    messagingSenderId: "716365636842",
    appId: "1:716365636842:web:4be3bfad6121da3abbe393",
    measurementId: "G-XQS2D4H84E"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const ROUNDS = 9;

  // Local: current scorecard stays local (fast/offline)
  let local = JSON.parse(localStorage.getItem("playNineLocal")) || {
    players: [],
    scores: [] // number or null (blank)
  };

  // Shared: history lives in Firestore
  let history = [];

  function saveLocal(){ localStorage.setItem("playNineLocal", JSON.stringify(local)); }

  // Passcode helpers (stored per device)
  function getPasscode() {
    return localStorage.getItem("playNinePasscode") || "";
  }

  function requirePasscode() {
    let code = getPasscode();
    if (!code) {
      code = prompt("Enter family passcode to save/delete history:");
      if (!code) return null;
      localStorage.setItem("playNinePasscode", code);
    }
    return code;
  }

  function changePasscode() {
    const code = prompt("Set/update family passcode on this device:");
    if (!code) return;
    localStorage.setItem("playNinePasscode", code);
    alert("Passcode updated on this device.");
  }

  // Tabs
  const scorecardView = document.getElementById("scorecardView");
  const historyView = document.getElementById("historyView");
  const scoreTab = document.getElementById("scoreTab");
  const historyTab = document.getElementById("historyTab");

  scoreTab.onclick = () => showScorecard();
  historyTab.onclick = () => showHistory();

  function showScorecard(){
    scorecardView.style.display = "block";
    historyView.style.display = "none";
    scoreTab.classList.add("active-tab");
    historyTab.classList.remove("active-tab");
  }

  async function showHistory(){
    scorecardView.style.display = "none";
    historyView.style.display = "block";
    historyTab.classList.add("active-tab");
    scoreTab.classList.remove("active-tab");
    await loadHistoryFromCloud();
    renderHistory();
  }

  // Controls
  document.getElementById("addPlayerBtn").onclick = addPlayer;
  document.getElementById("endGameBtn").onclick = endGame;
  document.getElementById("resetScoresBtn").onclick = resetScores;

  function addPlayer(){
    const input = document.getElementById("playerName");
    const name = input.value.trim();
    if (!name) return;

    local.players.push(name);
    local.scores.push(Array(ROUNDS).fill(null));

    input.value = "";
    saveLocal();
    renderScorecard();
  }

  function renamePlayer(i){
    const name = prompt("Rename player:", local.players[i]);
    if (!name) return;
    local.players[i] = name.trim();
    saveLocal();
    renderScorecard();
  }

  function deletePlayer(i){
    if (!confirm("Delete this player and all current scores?")) return;
    local.players.splice(i, 1);
    local.scores.splice(i, 1);
    saveLocal();
    renderScorecard();
  }

  function updateScore(p, r, value){
    local.scores[p][r] = value === "" ? null : Number(value);
    saveLocal();
    renderScorecard();
  }

  function getTotal(i){
    return local.scores[i].filter(v => v !== null).reduce((a,b) => a+b, 0);
  }

  // Lowest wins
  function getLeaders(){
    const totals = local.players.map((_, i) => getTotal(i));
    const min = Math.min(...totals);
    return totals.map(t => t === min);
  }

  function resetScores(){
    if (!confirm("Clear current scores?")) return;
    local.scores = local.players.map(() => Array(ROUNDS).fill(null));
    saveLocal();
    renderScorecard();
  }

  function renderCurrentRanking(){
    const ranking = local.players
      .map((name, i) => ({ name, total: getTotal(i) }))
      .sort((a,b) => a.total - b.total);

    return `
      <h2>Current Rankings</h2>
      <div class="table-wrapper">
        <table>
          <tr><th>Position</th><th>Player</th><th>Total</th></tr>
          ${ranking.map((p,i) =>
            `<tr><td>${i+1}</td><td>${escapeHtml(p.name)}</td><td>${p.total}</td></tr>`
          ).join("")}
        </table>
      </div>
    `;
  }

  function renderScorecard(){
    const table = document.getElementById("tableContainer");
    const rankingDiv = document.getElementById("ranking");

    if (!local.players.length){
      table.innerHTML = "<p class='muted'>Add players to begin</p>";
      rankingDiv.innerHTML = "";
      return;
    }

    const leaders = getLeaders();

    let html = "<table><tr><th>Round</th>";
    local.players.forEach((p,i) => {
      html += `
        <th class="${leaders[i] ? "leader" : ""}">
          <span class="player-header">
            ${escapeHtml(p)}
            <button onclick="window._renamePlayer(${i})">‚úèÔ∏è</button>
            <button onclick="window._deletePlayer(${i})">üóë</button>
          </span>
        </th>`;
    });
    html += "</tr>";

    for (let r=0; r<ROUNDS; r++){
      html += `<tr><td>Round ${r+1}</td>`;
      local.players.forEach((_, p) => {
        html += `
          <td class="${leaders[p] ? "leader" : ""}">
            <input type="number"
                   value="${local.scores[p][r] ?? ""}"
                   onchange="window._updateScore(${p}, ${r}, this.value)">
          </td>`;
      });
      html += "</tr>";
    }

    html += `<tr class="total-row"><td>Total</td>`;
    local.players.forEach((_, i) => {
      html += `<td class="${leaders[i] ? "leader" : ""}">${getTotal(i)}</td>`;
    });
    html += "</tr></table>";

    table.innerHTML = html;
    rankingDiv.innerHTML = renderCurrentRanking();
  }

  window._renamePlayer = renamePlayer;
  window._deletePlayer = deletePlayer;
  window._updateScore = updateScore;

  // Firestore (shared history)
  async function loadHistoryFromCloud(){
    // IMPORTANT CHANGE:
    // Load ALL games ordered by createdAt, then filter deleted client-side.
    // This makes older documents (missing `deleted`) still show up.
    const q = query(collection(db, "games"), orderBy("createdAt", "desc"));
    const snap = await getDocs(q);

    history = snap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(g => g.deleted !== true); // treat missing as not deleted
  }

  async function endGame(){
    if (!local.players.length) return;

    const passcode = requirePasscode();
    if (!passcode) return;

    if (!confirm("End game and save results to shared history?")) return;

    try {
      const totals = local.players.map((name, i) => ({ name, total: getTotal(i) }));
      const min = Math.min(...totals.map(t => t.total));
      const winners = totals.filter(t => t.total === min).map(t => t.name);

      await addDoc(collection(db, "games"), {
        createdAt: serverTimestamp(),
        dateLabel: new Date().toLocaleString(),
        winners,
        totals,
        deleted: false,
        passcode
      });

      local.scores = local.players.map(() => Array(ROUNDS).fill(null));
      saveLocal();
      renderScorecard();
    } catch (err) {
      alert("‚ùå Wrong passcode. Game was NOT saved.");
      localStorage.removeItem("playNinePasscode");
    }
  }

  async function deleteGame(index){
    const g = history[index];
    if (!g?.id) return;

    const passcode = requirePasscode();
    if (!passcode) return;

    if (!confirm("Delete this game from shared history?")) return;

    try {
      // Soft delete (works with rules)
      await updateDoc(doc(db, "games", g.id), {
        deleted: true,
        passcode
      });

      await loadHistoryFromCloud();
      renderHistory();
    } catch (err) {
      alert("‚ùå Wrong passcode. Game was NOT deleted.");
      localStorage.removeItem("playNinePasscode");
    }
  }
  window._deleteGame = deleteGame;

  // Summary: best winning score + worst single-player score, with player names
  function computeHistorySummary(){
    if (!history.length) {
      return { bestWin: null, bestWinPlayer: null, worstAny: null, worstAnyPlayer: null, games: 0 };
    }

    let bestWin = null, bestWinPlayer = null;
    let worstAny = null, worstAnyPlayer = null;

    history.forEach(g => {
      const winners = new Set(g.winners || []);
      (g.totals || []).forEach(t => {
        const score = Number(t.total) || 0;
        const name = t.name;

        if (winners.has(name)) {
          if (bestWin === null || score < bestWin) {
            bestWin = score;
            bestWinPlayer = name;
          }
        }

        if (worstAny === null || score > worstAny) {
          worstAny = score;
          worstAnyPlayer = name;
        }
      });
    });

    return { bestWin, bestWinPlayer, worstAny, worstAnyPlayer, games: history.length };
  }

  function renderAllTimeLeaderboard(){
    const stats = {};

    history.forEach(g => {
      const winners = new Set(g.winners || []);
      (g.totals || []).forEach(t => {
        const name = t.name;
        const score = Number(t.total) || 0;

        if (!stats[name]) stats[name] = { name, games: 0, wins: 0, totalScore: 0 };
        stats[name].games++;
        stats[name].totalScore += score;
        if (winners.has(name)) stats[name].wins++;
      });
    });

    const rows = Object.values(stats).map(p => {
      const avg = p.games ? (p.totalScore / p.games) : 0;
      const winPct = p.games ? (p.wins / p.games) : 0;
      return { ...p, avg, winPct };
    })
    .sort((a,b) => (b.wins - a.wins) || (b.winPct - a.winPct) || (a.avg - b.avg));

    if (!rows.length) return "<p class='muted'>No games yet.</p>";

    return `
      <h2>All-Time Leaderboard</h2>
      <div class="table-wrapper">
        <table>
          <tr>
            <th>Rank</th>
            <th>Player</th>
            <th>Wins</th>
            <th>Games</th>
            <th>Win %</th>
            <th>Avg</th>
          </tr>
          ${rows.map((p,i) => `
            <tr>
              <td>${i+1}</td>
              <td>${escapeHtml(p.name)}</td>
              <td>${p.wins}</td>
              <td>${p.games}</td>
              <td>${(p.winPct * 100).toFixed(0)}%</td>
              <td>${p.avg.toFixed(1)}</td>
            </tr>
          `).join("")}
        </table>
      </div>
    `;
  }

  function renderHistory(){
    if (!history.length){
      historyView.innerHTML = `
        <h2>No games played yet</h2>
        <div class="history-actions">
          <button class="light" onclick="window._changePasscode()">üîë Change Passcode</button>
        </div>
        <p class="muted">History is shared in Firestore. Enter your family passcode when saving/deleting.</p>
      `;
      return;
    }

    const summary = computeHistorySummary();

    const bestText = summary.bestWin !== null
      ? `${summary.bestWin} (${escapeHtml(summary.bestWinPlayer)})`
      : "‚Äî";

    const worstText = summary.worstAny !== null
      ? `${summary.worstAny} (${escapeHtml(summary.worstAnyPlayer)})`
      : "‚Äî";

    historyView.innerHTML = `
      <div class="history-actions">
        <button class="light" onclick="window._changePasscode()">üîë Change Passcode</button>
      </div>

      <div class="summary-cards">
        <div class="card">
          <div class="label">All-time Best Game Score (lowest winning score)</div>
          <div class="value">
            <span class="badge trophy" title="Best score">üèÜ</span>
            <span>${bestText}</span>
          </div>
        </div>

        <div class="card">
          <div class="label">All-time Worst Score (highest single-player total)</div>
          <div class="value">
            <span class="badge oops" title="Worst score">üò¨</span>
            <span>${worstText}</span>
          </div>
        </div>

        <div class="card">
          <div class="label">Games Recorded</div>
          <div class="value">
            <span class="badge" title="Games">‚õ≥</span>
            <span>${summary.games}</span>
          </div>
        </div>
      </div>

      ${renderAllTimeLeaderboard()}

      <h2>Game History</h2>
      <div class="table-wrapper">
        <table>
          <tr><th>Date</th><th>Winner(s)</th><th>Scores</th><th></th></tr>
          ${history.map((g,i) => `
            <tr>
              <td>${escapeHtml(g.dateLabel || "")}</td>
              <td>${escapeHtml((g.winners || []).join(", "))}</td>
              <td>${escapeHtml((g.totals || []).map(t => `${t.name}: ${t.total}`).join(" | "))}</td>
              <td><button class="danger" onclick="window._deleteGame(${i})">üóë Delete</button></td>
            </tr>
          `).join("")}
        </table>
      </div>

      <p class="muted">History + leaderboard are shared (Firestore). Scorecard-in-progress stays on your device.</p>
    `;
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  window._changePasscode = changePasscode;

  // Initial render
  renderScorecard();
</script>

</body>
</html>
